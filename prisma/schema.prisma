generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Base Profiles Table (Data Member)
model profiles {
  id                String   @id @default(dbgenerated("auth.uid()")) @db.Uuid
  member_id         String?  @unique
  email             String?
  full_name         String?
  generation        String?
  phone             String?
  gender            String?
  birth_place       String?
  birth_date        DateTime? @db.Date
  education_level   String?
  university        String?
  faculty           String?
  major             String?
  domicile_country  String?
  domicile_province String?
  domicile_city     String?
  photo_url         String?
  linkedin_url      String?
  
  // Job Info
  industry_sector   String?
  job_type          String?
  job_position      String?
  company_name      String?
  
  // Entrepreneurship
  has_business      Boolean?  @default(false)
  business_name     String?
  business_desc     String?
  business_field    String?
  business_position String?
  business_location String?
  
  // Interests
  hobbies           String?
  interests         String?
  communities       String?
  
  // Metadata
  account_status    String?   @default("Active")
  role              String?   @default("member") // Added based on context
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  event_registrations event_participants[]
  staff_assignments   event_staff[]
  transactions        event_transactions[] @relation("ParticipantTransactions")
  scanned_transactions event_transactions[] @relation("StaffScans")
}

/// Events Table (Agenda)
model events {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  date_start  DateTime? @db.Timestamptz(6)
  location    String?
  status      String?   @default("Open")
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  participants event_participants[]
  staff        event_staff[]
  coupons      event_coupons[]
  transactions event_transactions[]
}

/// Event Participants (Pendaftaran Event)
model event_participants {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id      String    @db.Uuid
  user_id       String    @db.Uuid
  registered_at DateTime? @default(now()) @db.Timestamptz(6)
  
  // New columns from V2
  check_in_time DateTime? @db.Timestamptz(6)
  notes         String?
  tags          String[]

  // Relations
  event   events   @relation(fields: [event_id], references: [id], onDelete: Cascade)
  profile profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([event_id, user_id])
}

/// Temp Registrations (TempPendaftar)
model temp_registrations {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  submitted_at DateTime? @default(now()) @db.Timestamptz(6)
  status       String?   @default("Pending")
  full_name    String?
  email        String?
  whatsapp     String?
  pin          String?
  raw_data     Json?
}

/// Event Staff Table
model event_staff {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id   String    @db.Uuid
  user_id    String    @db.Uuid
  role       String    // 'Koordinator', 'Registrasi', etc
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  event   events   @relation(fields: [event_id], references: [id], onDelete: Cascade)
  profile profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([event_id, user_id])
}

/// Event Coupons (Logistics)
model event_coupons {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id       String    @db.Uuid
  name           String    // 'Lunch', 'Snack'
  quota_per_user Int?      @default(1)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  event        events              @relation(fields: [event_id], references: [id], onDelete: Cascade)
  transactions event_transactions[]
}

/// Event Transactions (Redemptions)
model event_transactions {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id    String    @db.Uuid
  user_id     String    @db.Uuid // Participant
  coupon_id   String    @db.Uuid
  staff_id    String?   @db.Uuid // Who scanned
  redeemed_at DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  event       events        @relation(fields: [event_id], references: [id], onDelete: Cascade)
  participant profiles      @relation("ParticipantTransactions", fields: [user_id], references: [id], onDelete: Cascade)
  coupon      event_coupons @relation(fields: [coupon_id], references: [id], onDelete: Cascade)
  staff       profiles?     @relation("StaffScans", fields: [staff_id], references: [id], onDelete: SetNull)
}
